<?xml version="1.0"?>

<!DOCTYPE plugin [
        <!ENTITY process-metrics SYSTEM "/pdk/plugins/process-metrics.xml">
        <!ENTITY jvm-jmx-metrics SYSTEM "/pdk/plugins/jvm-jmx-metrics.xml">
        ]>
<plugin package="com.navis.ecn4">

    <classpath>
        <include name="pdk/lib/mx4j"/>
    </classpath>

    <filter name="template" value="${OBJECT_NAME}:${alias}"/>

    <metrics name="Domain Model Gate">
        <metric name="Delete Queue" alias="DeleteQueueSize" indicator="true" category="THROUGHPUT" interval="30000"/>
        <metric name="Insert Queue" alias="InsertQueueSize" indicator="true" category="THROUGHPUT" interval="30000"/>
        <metric name="Unit Queue" alias="UnitQueueSize" indicator="true" category="THROUGHPUT" interval="30000"/>
        <metric name="Work Instruction Queue" alias="WorkInstructionQueueSize" indicator="true" category="THROUGHPUT" interval="30000"/>
    </metrics>

    <metrics name="Cache Event">
        <metric name="Event Queue" alias="QueueSize" indicator="true" category="THROUGHPUT" interval="30000"/>
    </metrics>

    <metrics name="Domain Model Count">
        <metric name="Total Count" alias="Count" indicator="true" category="THROUGHPUT" interval="30000"/>
        <metric name="Moving Avg" alias="MovingAverage" indicator="true" category="THROUGHPUT" interval="30000"/>
    </metrics>

    <server name="ECN4">
        <property name="PROC_HOME_PROPERTY" value="com.navis.ecn4.settings.file"/>
        <property name="HAS_BUILTIN_SERVICES" value="true"/>

        <config>
            <option name="jmx.url" description="JMX URL to MBeanServer" default="service:jmx:rmi:///jndi/rmi://localhost:13104/jmxrmi"/>
            <option name="jmx.username" description="JMX username" optional="true" default=""/>
            <option name="jmx.password" description="JMX password" optional="true" default="" type="secret"/>
            <!--<option name="process.query" description="PTQL for standalone ECN4 process" default="State.Name.sw=java,Args.*.ct=n4-ecn4.jar"/>-->
            <option name="process.query" description="PTQL for ECN4 in Apache Service Wrapper" default="State.Name.eq=ecn4"/>
        </config>

        <plugin type="autoinventory" class="org.hyperic.hq.product.jmx.MxServerDetector"/>
        <plugin type="measurement" class="org.hyperic.hq.product.jmx.MxMeasurementPlugin"/>

        <metric name="Availability" template="sigar:Type=ProcState,Arg=%process.query%:State" indicator="true"/>
        &process-metrics;
        &jvm-jmx-metrics;
        <service name="Data Interface to SPARCS">
            <plugin type="autoinventory"/>

            <property name="OBJECT_NAME" value="com.navis.ecn4.DomainModel:type=Gate"/>
            <metrics include="Domain Model Gate"/>

            <property name="OBJECT_NAME" value="com.navis.ecn4.cache.InputQueue:type=InputQueue,name=*"/>
            <metrics include="Cache Event"/>
            <metric name="Availability" indicator="true"/>
        </service>

        <service name="Memory Model">
            <plugin type="autoinventory"/>

            <property name="OBJECT_NAME" value="com.navis.ecn4.gc.GarbageCollector:type=GC"/>
            <metric name="Availability" indicator="true"/>
            <metric name="Last batch size" alias="LastRemovedEntitiesCount" indicator="true" category="THROUGHPUT" interval="30000"/>
        </service>

        <service name="Coherence">
            <plugin type="autoinventory"/>

            <property name="OBJECT_NAME" value="Coherence:type=Cluster"/>
            <metric name="Availability" indicator="true"/>
            <metric name="Cluster size" alias="ClusterSize" indicator="true" category="THROUGHPUT" interval="30000"/>

            <property name="OBJECT_NAME" value="Coherence:type=Cache,service=*,name=*,nodeId=1,tier=back"/>
            <metric name="Objects in cache" alias="Size" indicator="true" category="THROUGHPUT" interval="30000"/>
        </service>

        <service name="Domain Model Statistics">
            <plugin type="autoinventory"/>

            <property name="OBJECT_NAME" value="com.navis.ecn4.memory.impl.DomainModelCount:type=Total Count,name=*"/>
            <metrics include="Domain Model Count"/>
            <metric name="Availability" indicator="true"/>
        </service>

        <service name="Threads">
            <plugin type="autoinventory"/>

            <property name="OBJECT_NAME" value="java.lang:type=Threading"/>
            <metric name="Availability" indicator="true"/>
            <metric name="Thread count" alias="ThreadCount" indicator="true" category="THROUGHPUT" interval="30000"/>
            <metric name="Peak thread count" alias="PeakThreadCount" indicator="true" category="THROUGHPUT" collectionType="trendsup"
                    interval="30000"/>
            <metric name="Total started thread count" alias="TotalStartedThreadCount" indicator="true" category="THROUGHPUT" interval="30000"/>
        </service>
    </server>
    <help name="ECN4">
        <![CDATA[
    <h3>Configure HQ for monitoring ECN4</h3>
    <p>
    1) Configure ECN4's JMX statistics collection follow the instructions on:
    <a href="http://confluence.navis.com/display/ECN4/Monitoring+ECN4">Monitoring ECN4</a></li>
    </p>
    <p>
    2) Add this line to the top of the service wrapper configuration
    <br>
    -Dcom.sun.management.jmxremote.port=13104
    <br>
    -Dcom.sun.management.jmxremote.ssl=false
    <br>
    -Dcom.sun.management.jmxremote.authenticate=false
    </p>
    ]]>
    </help>
</plugin>
